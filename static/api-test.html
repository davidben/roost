<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Roost</title>
    <script src="/q.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/winchan.js"></script>
  </head>
  <style>
    #log {
      height: 500px;
      overflow: scroll;
    }
  </style>
  <body>
    <button id="clearlog">Clear log</button>
    <form id="subscribe">
      <input name="class">
      <input name="instance" value="*">
      <input name="recipient" value="">
      <input type="submit" value="Subscribe">
    </form>
    <br>
    <form id="unsubscribe">
      <input name="class">
      <input name="instance" value="*">
      <input name="recipient" value="">
      <input type="submit" value="Unsubscribe">
    </form>
    <form id="getmessages">
      <input name="offset">
      <input type="submit" value="Load messages">
    </form>
    <pre id="log"></pre>
    <script>
      (function() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/api/v1/subscriptions", true);
        xhr.onreadystatechange = function(ev) {
          if (this.readyState != 4) return;
          if (this.status == 200) {
            var subs = JSON.parse(this.responseText);
            log("Currently subscribed to:");
            subs.forEach(function(sub) {
              var inst = sub[1] == null ? '*' : sub[1];
              log(" <" + sub[0] + "," + inst + "," + sub[2] + ">");
            });
          } else {
            log("Failed to get subscriptions");
          }
        };
        xhr.send();
      })();

      var creds = null;
      function getZephyrCreds() {
        if (creds)
          return Q(creds);
        var deferred = Q.defer();
        WinChan.open({
          url: "https://webathena.mit.edu/#!request_ticket_v1",
          relay_url: "https://webathena.mit.edu/relay.html",
          params: {
            services: [
              {
                realm: 'ATHENA.MIT.EDU',
                principal: ['zephyr', 'zephyr'],
              }
            ]
          }
        }, function (err, r) {
          console.log("got reply", err, r);
	  if (err) {
	    deferred.reject(err);
	    return;
	  }
          if (r.status !== "OK") {
	    deferred.reject(r);
	    return;
          }
          creds = r.sessions[0];
          deferred.resolve(creds);
        });
        return deferred.promise;
      }

      document.getElementById("clearlog").addEventListener("click", function(ev) {
        document.getElementById("log").textContent = "";
      });

      document.getElementById("subscribe").addEventListener("submit", function(ev) {
        ev.preventDefault();

        var msgClass = this.class.value;
        var msgInstance = this.instance.value;
        if (msgInstance == '*') msgInstance = null; // Meh.
        var msgRecipient = this.recipient.value;
        if (msgRecipient == "%me%")
          msgRecipient = "davidben@ATHENA.MIT.EDU";

        var credsPromise;
        if (msgRecipient && msgRecipient[0] !== '@') {
          credsPromise = getZephyrCreds();
        } else {
          credsPromise = Q();
        }
        credsPromise.then(function(creds) {
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/api/v1/subscribe", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          // Pffft.
          xhr.onreadystatechange = function(ev) {
            if (this.readyState != 4) return;
            if (this.status == 200) {
              log("Subscribed to " + msgClass);
            } else {
              log("Failed to subscribed to " + msgClass);
            }
          };
          xhr.send(JSON.stringify({
            subscription: [msgClass, msgInstance, msgRecipient],
            credentials: creds
          }));
        }).done();
      });

      document.getElementById("unsubscribe").addEventListener("submit", function(ev) {
        ev.preventDefault();

        var msgClass = this.class.value;
        var msgInstance = this.instance.value;
        if (msgInstance == '*') msgInstance = null; // Meh.
        var msgRecipient = this.recipient.value;
        if (msgRecipient == "%me%")
          msgRecipient = "davidben@ATHENA.MIT.EDU";

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/v1/unsubscribe", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        // Pffft.
        xhr.onreadystatechange = function(ev) {
          if (this.readyState != 4) return;
          if (this.status == 200) {
            log("Unsubscribed from " + msgClass);
          } else {
            log("Failed to unsubscribed from " + msgClass);
          }
        };
        xhr.send(JSON.stringify({
          subscription: [msgClass, msgInstance, msgRecipient],
        }));
      });

      document.getElementById("getmessages").addEventListener("submit", function(ev) {
        ev.preventDefault();

        var offset = this.offset.value;

        var xhr = new XMLHttpRequest();
        xhr.open("GET",
                 "/api/v1/messages?offset=" + encodeURIComponent(offset) + "&count=10",
                 true);
        xhr.onreadystatechange = function(ev) {
          if (this.readyState != 4) return;
          if (this.status == 200) {
            var result = JSON.parse(this.responseText);
            result.messages.forEach(function(msg) {
              log(msg.id + ": " + msg.class + " / " + msg.instance + " / " +
                  msg.sender + " " + new Date(msg.time) + "\n" +
                  msg.message + "\n");
            });
          } else {
            log("Failed to get messages");
          }
        };
        xhr.send();
      });


      function log(msg) {
        document.getElementById("log").textContent += msg + "\n";
      }

      var socket = io.connect("");
      socket.on("messages", function(id, msgs, isDone) {
        console.log(id, isDone, msgs.length);
      });
      // socket.emit("new-tail", 0, null, false);
      // socket.emit("extend-tail", 0, 10);
    </script>
  </body>
</html>
