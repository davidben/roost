<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Roost</title>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <form id="subscribe">
      <input name="class">
      <input type="submit" value="Subscribe">
    </form>
    <br>
    <form id="unsubscribe">
      <input name="class">
      <input type="submit" value="Unsubscribe">
    </form>
    <pre id="log"></pre>
    <script>
      document.getElementById("subscribe").addEventListener("submit", function(ev) {
        ev.preventDefault();

        var msgClass = this.class.value;
        var msgInstance = null;

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/subscribe", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        // Pffft.
        xhr.onreadystatechange = function(ev) {
          if (this.readyState != 4) return;
          if (this.status == 200) {
            log("Subscribed to " + msgClass);
          } else {
            log("Failed to subscribed to " + msgClass);
          }
        };
        xhr.send(JSON.stringify({
            class: msgClass,
            instance: msgInstance
        }));
      });

      document.getElementById("unsubscribe").addEventListener("submit", function(ev) {
        ev.preventDefault();

        var msgClass = this.class.value;
        var msgInstance = null;

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/unsubscribe", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        // Pffft.
        xhr.onreadystatechange = function(ev) {
          if (this.readyState != 4) return;
          if (this.status == 200) {
            log("Unsubscribed from " + msgClass);
          } else {
            log("Failed to unsubscribed from " + msgClass);
          }
        };
        xhr.send(JSON.stringify({
            class: msgClass,
            instance: msgInstance
        }));
      });

      function log(msg) {
        document.getElementById("log").textContent += msg + "\n";
      }

      var socket = io.connect("");
      socket.on('message', function(msg) {
        console.log(msg);
        log(msg.class + " / " + msg.instance + " / " + msg.sender + "\n" +
            msg.body + "\n");
      });
    </script>
  </body>
</html>
